# ADAS感知架构

自动驾驶的商业化还有些遥远，而高级辅助驾驶（ADAS）已经装备量产。甚至8万元的车型都配备了自适应巡航（ACC）,自动辅助刹车(AEB)功能。
环境感知是决策和控制的前提。下面对ADAS中感知的架构和模块做一个介绍。

## 1.传感器融合架构分为
因为不同的传感器有各自的优缺点，所以需要将传感器融合来扬长避短。
在ADAS中最普遍的传感器是摄像头与毫米波雷达的。
摄像头优势目标识别，对目标分类车辆，自行车，行人等目标。劣势距离信息不是直接测量得到的，不准确。特别是在恶劣环境和光照不足的环境下。
毫米波雷达优势直接测量目标的位置和速度。并且受到天气及环境的影响小。
劣势在于雷达的信号较为稀疏，不便通过雷达进行目标识别。这些性质正好与摄像头形成互补。
信息融合又可分为目标级融合和信号级融合。
目标级融合，每个传感器先各自处理原始信号生成目标。在目标的基础上进行融合。优点是对控制器的算力和通信传输要求低。缺点是传感器在独立处理信号时会有信息丢失。
数据级融合，在原始数据级就进行融合优点是信息丢失少，精度高，缺点是对控制器的算力和通信传输要求高。
在设计架构时需要找到精度和算力分布的平衡点。

一个摄像头和雷达目标级的传感器融合。雷达输出target信号，摄像头为类似mobileye的智能摄像头输出track信号
架构分为数据有效性验证，时间补偿，雷达聚类，目标匹配，新目标生成，航迹追踪，目标管理等子模块
下面将对雷达聚类，目标匹配，航迹追踪进行介绍

## 1.雷达聚类 
毫米波雷达通过分析雷达反射的回波进行目标的定位测速
雷达之前步骤, 处理硬件实现，
回波通过快速傅里叶变换fft，反射点，恒虚警处理cfar，关键点。这些步骤一般在内雷达部件内部完成。
一般输出的信号，target，object，track
将target信号为未经过聚类的反射点。由于回波反射，特别是在旁边车辆，隧道，或者有路边栅栏的情况，回波多次反射噪音较大。一个目标也会出现多个target信号。
object为聚类之后的目标点。置信度高于object
track是目标进行追踪后，带有ID，置信度最高

聚类是从 target到object步骤。
target杂波较多，需要进行目标过滤。
静止目标，对象面车，ROI(region of interest)外的目标进行滤除。

和一般聚类算法，相比雷达聚类不知道簇的个数，对是实时性要求高。
在距离参数上，除了空间距欧式离外，可用用加权的欧式距离
雷达只能提供径向距离和速度，不能提供切向值，距离较准，角度不准
或者采用马氏距离，通过标准差在对距离加权
fig

常用的聚类方法有基于距离eclidean clustering，基于密度dbscan
在核心的选择上可以反射能量大的点，或者以上次聚类的结果为核心。
示例程序

## 2.目标匹配
目标匹配的目的是传感器的目标与航迹进行匹配。
在匹配之前先设置gate。对点门限值以外的目标进行初步删选。
gating 方法，在每个track，周围根据距离速度。只有在阈值内才进行匹配。

对匹配的假设会出现多的情况一配多，一配一，多配一。

我们以一配一为例
1. 计算距离矩阵
2个列表，计算列表1中每个点到列表2中每个点的距离。
如果之前一步gating中已经删除，
马氏距离,卡方分布，
gnn, global nearest neighbor
在距离参数上，除了空间距欧式离外，可用用加权的欧式距离
计算马氏距离时间采用joint probability
除了采用定义的距离外还可以一概率作为匹配的指标pda probablity data assication，通过卡尔曼的残值来计算匹配的概率
如果问题是一对一匹配需要用到jpda，joint
2. linear assignment 线性分配
列表一对一匹配。
最有接，匈牙利算法，多次迭代，复杂的On4，实际情况，不需要最优解。
贪心算法。
计算全局的最小值匹配，把匹配后那行和列都删掉。再在剩下的值中找最小值重复上述步骤。知道列表为空或者最小值大于某阈值。
joint covance用了观测协方差，观测协方差估了个常数，再和fusion obj的协方差一起算出pooled covariance，用pooled covariance 算马氏距离

根据数据的特性，如果匹配基本明确，如果不明确例如在一个门控区域中有多个观测值；或者在共同观测值在多个门控区域
但是，如果关联不明确，则分配决策变得耦合且难以解决。可以采用mht, multi hypothesis tracking
匹配讲义

## 3. 航迹追踪
卡尔曼滤波是航迹追踪最经典的算法。航迹与雷达和相机的匹配结构后，通过卡尔曼预测值和观测值进行更新。
需要如果目标的运动模型是质点模型，横坐标方向匀速运动，纵坐标方向匀加速
注意的是雷达的观测矩阵ekf, 雷达，
1.雷达的观测矩阵
1.相机激光雷达的观测矩阵
相机的观测矩阵线性
如果运动模型选用更复杂的模型如速度航向角模型 ufk，如果用到多轨迹假设 pf

卡尔曼调参，
可调参数
虽然有物理含义但是很难从理论上得到值，需要手动
P（初始前验协方差）：初始增益的大小可以决定初始收敛速度
Q（过程噪音协方差）：Q小时增益也小，因为这时依赖模
R（观测噪声协方差）：性能指标决定了稳态的噪声，小了初始增益大，但是稳态容易引入噪声
RSME ( Root Mean Square Error): 用于定量分析目标位置精度。

真值激光雷达，
如果没有这只可以用稳定平滑当作真值。传感器加入扰动。高斯噪声效果不好，因为很容易被卡尔曼滤除，
真实更常见的是跳动，相机识别跳到，目标匹配错误产生的跳动，幅值会较大。

如果当前没有观测值，卡尔曼制作预测不做更新
可以设置不同情况，不同参数，如果相机发现目标前2秒，位置速度不准确，可以采用较大的R
在航迹管理，航迹合并，丢失几帧删除

## 4. 难点
1. 目标个旁边障碍物区分，速度最为gate
2. 并行目标区分，如果辆车并行速度相似，雷达较难区分，因为雷达角分辨率较低，相机可以区分。
3. 遮挡障碍物，相机被遮挡，当前车cutout后容易发生危险，雷达有时可以穿透，提前做出预警
4. 误报警，单雷达会对井盖，存在误报警，相机确认
5. 漏报警，雨天相机漏报，雷达的信息，如果只有单雷达信息。误报，漏报存在权衡，根据功能定义，指定区域，标定，L2级ADAS，误报警首先降低。因为由人负责，频繁误报警会抱怨。
